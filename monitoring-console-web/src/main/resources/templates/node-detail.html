<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Node Detail - HestiaStore Console</title>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap');

    :root {
      --bg-a: #ecf3ef;
      --bg-b: #d8e9df;
      --panel: rgba(255, 255, 255, 0.84);
      --text: #143226;
      --muted: #4b6e5d;
      --ok: #0f9d6b;
      --warn: #d48a12;
      --bad: #c54b3b;
      --accent: #0d8f81;
      --shadow: 0 18px 38px rgba(20, 50, 38, 0.14);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 10% 10%, rgba(214, 97, 59, 0.22), transparent 35%),
        radial-gradient(circle at 85% 20%, rgba(13, 143, 129, 0.30), transparent 35%),
        linear-gradient(135deg, var(--bg-a), var(--bg-b));
      min-height: 100vh;
    }

    .shell {
      max-width: 1320px;
      margin: 0 auto;
      padding: 26px 20px 32px;
    }
    .card {
      border-radius: 18px;
      background: var(--panel);
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,.66);
    }
    .top {
      padding: 16px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .logo-wrap {
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    .logo-wrap img {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid rgba(20,50,38,.12);
      background: #fff;
    }
    .mono {
      font-family: "IBM Plex Mono", ui-monospace, monospace;
      font-size: 12px;
      color: var(--muted);
    }
    .btn {
      border: 0;
      border-radius: 10px;
      font: inherit;
      padding: 8px 12px;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--text);
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(20,50,38,.12);
      font-size: 13px;
      font-weight: 600;
    }
    .btn.alt {
      color: #fff;
      background: linear-gradient(135deg, #d6613b, #a7462a);
      border: 0;
    }
    .btn.pri {
      color: #fff;
      background: linear-gradient(135deg, var(--accent), #0a6c61);
      border: 0;
    }
    .btn-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .kpis {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(6, 1fr);
      margin-bottom: 16px;
    }
    .kpi {
      padding: 14px 16px;
    }
    .kpi-label {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .05em;
    }
    .kpi-value {
      margin-top: 8px;
      font-size: 24px;
      font-weight: 700;
    }

    .grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(2, 1fr);
    }
    .section {
      padding: 14px 16px;
    }
    .section h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }
    .line {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding: 5px 0;
      border-bottom: 1px solid rgba(20,50,38,.08);
      font-size: 14px;
    }
    .value-runtime {
      color: var(--text);
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .value-runtime::before {
      content: "";
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--ok);
      box-shadow: 0 0 0 0 rgba(15,157,107,.5);
      animation: pulse 1.5s infinite;
    }
    .value-config {
      color: var(--muted);
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .value-config::before {
      content: "ðŸ”’";
      font-size: 12px;
      line-height: 1;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(15,157,107,.45); }
      70% { box-shadow: 0 0 0 7px rgba(15,157,107,0); }
      100% { box-shadow: 0 0 0 0 rgba(15,157,107,0); }
    }
    .legend {
      padding: 14px 16px;
      margin-top: 16px;
      font-size: 13px;
      color: var(--muted);
    }
    .legend h3 {
      margin: 0 0 10px;
      color: var(--text);
      font-size: 15px;
    }
    .legend p {
      margin: 6px 0;
    }

    .warn {
      padding: 14px 16px;
      color: #b65d00;
      margin-bottom: 16px;
    }

    @media (max-width: 1220px) {
      .kpis { grid-template-columns: repeat(3, 1fr); }
      .grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 760px) {
      .kpis { grid-template-columns: repeat(2, 1fr); }
      .top { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
<main class="shell">
  <div class="card top">
    <div class="logo-wrap">
      <img src="/images/hestiastore-logo.png" alt="HestiaStore logo">
      <div>
        <div style="font-size:24px; font-weight:700; line-height:1;">HestiaStore Console</div>
        <div class="mono" th:if="${node != null}" th:text="${node.nodeName + ' / ' + node.nodeId}">index-1 / node-1</div>
      </div>
    </div>
    <div class="btn-row">
      <div th:if="${node != null}" class="btn-row">
        <form action="/actions/flush" method="post" hx-post="/actions/flush"
              hx-target="#flash" hx-swap="innerHTML">
          <input type="hidden" name="nodeId" th:value="${node.nodeId}">
          <input type="hidden" name="returnTo" value="node">
          <button class="btn pri" type="submit">Flush</button>
        </form>
        <form action="/actions/compact" method="post"
              hx-post="/actions/compact" hx-target="#flash"
              hx-swap="innerHTML">
          <input type="hidden" name="nodeId" th:value="${node.nodeId}">
          <input type="hidden" name="returnTo" value="node">
          <button class="btn alt" type="submit">Compact</button>
        </form>
      </div>
      <a class="btn" href="/">Back to dashboard</a>
    </div>
  </div>

  <div id="flash" th:replace="~{fragments/flash :: flash}">
    <div class="card legend">Status messages.</div>
  </div>

  <div th:if="${node == null}" class="card warn">
    Node not found: <span th:text="${missingNodeId}">node</span>
  </div>

  <div th:if="${node != null}">
    <section class="kpis">
      <article class="card kpi"><div class="kpi-label">Segments</div><div class="kpi-value" th:text="${node.segmentCount}">0</div></article>
      <article class="card kpi"><div class="kpi-label">Segment Cache Keys</div><div class="kpi-value" th:text="${node.totalSegmentCacheKeys}">0</div></article>
      <article class="card kpi"><div class="kpi-label">Write Cache Keys</div><div class="kpi-value" th:text="${node.totalWriteCacheKeys}">0</div></article>
      <article class="card kpi"><div class="kpi-label">Heap Used</div><div class="kpi-value" th:text="${node.heapUsedHumanReadable}">0 B</div></article>
      <article class="card kpi"><div class="kpi-label">GC Count</div><div class="kpi-value" th:text="${node.jvmGcCount}">0</div></article>
      <article class="card kpi"><div class="kpi-label">GC Time (ms)</div><div class="kpi-value" th:text="${node.jvmGcTimeMillis}">0</div></article>
    </section>

    <section class="grid">
      <article class="card section">
        <h3>Segment Runtime</h3>
        <div class="line"><span>Number of segments</span><strong class="value-runtime" th:text="${node.segmentCount}">0</strong></div>
        <div class="line"><span>Total Keys</span><strong class="value-runtime" th:text="${node.totalSegmentKeys}">0</strong></div>
        <div class="line"><span>Delta Cache Files</span><strong class="value-runtime" th:text="${node.totalDeltaCacheFiles}">0</strong></div>
      </article>

      <article class="card section">
        <h3>Compaction / Split / Flush</h3>
        <div class="line"><span>Total Flush Requests</span><strong class="value-runtime" th:text="${node.flushRequestCount}">0</strong></div>
        <div class="line"><span>Current Flush Rate</span><strong class="value-runtime" th:text="${node.flushRateDisplay}">0 /s</strong></div>
        <div class="line"><span>Total Split Schedules</span><strong class="value-runtime" th:text="${node.splitScheduleCount}">0</strong></div>
        <div class="line"><span>Current Split Rate</span><strong class="value-runtime" th:text="${node.splitRateDisplay}">0 /s</strong></div>
        <div class="line"><span>Total Compaction Requests</span><strong class="value-runtime" th:text="${node.compactRequestCount}">0</strong></div>
        <div class="line"><span>Current Compaction Rate</span><strong class="value-runtime" th:text="${node.compactRateDisplay}">0 /s</strong></div>
      </article>

      <article class="card section">
        <h3>Operations</h3>
        <div class="line"><span>Total Get Operations</span><strong class="value-runtime" th:text="${node.getOps}">0</strong></div>
        <div class="line"><span>Total Put Operations</span><strong class="value-runtime" th:text="${node.putOps}">0</strong></div>
        <div class="line"><span>Total Delete Operations</span><strong class="value-runtime" th:text="${node.deleteOps}">0</strong></div>
        <div class="line"><span>Total Operations</span><strong class="value-runtime" th:text="${node.totalOps}">0</strong></div>
        <div class="line"><span>Current Throughput</span><strong class="value-runtime" th:text="${node.currentThroughputDisplay}">0 ops/s</strong></div>
      </article>

      <article class="card section">
        <h3>Latency Percentiles (micros)</h3>
        <div class="line"><span>Read p50</span><strong class="value-runtime" th:text="${node.readLatencyP50Micros}">0</strong></div>
        <div class="line"><span>Read p95</span><strong class="value-runtime" th:text="${node.readLatencyP95Micros}">0</strong></div>
        <div class="line"><span>Read p99</span><strong class="value-runtime" th:text="${node.readLatencyP99Micros}">0</strong></div>
        <div class="line"><span>Write p50</span><strong class="value-runtime" th:text="${node.writeLatencyP50Micros}">0</strong></div>
        <div class="line"><span>Write p95</span><strong class="value-runtime" th:text="${node.writeLatencyP95Micros}">0</strong></div>
        <div class="line"><span>Write p99</span><strong class="value-runtime" th:text="${node.writeLatencyP99Micros}">0</strong></div>
      </article>

      <article class="card section">
        <h3>Segment Cache</h3>
        <div class="mono" style="margin-bottom:8px;">Values are aggregated over all segments in this node.</div>
        <div class="line"><span>maxNumberOfKeysInSegmentCache</span><strong class="value-config" th:text="${node.segmentCacheKeyLimitPerSegment}">0</strong></div>
        <div class="line"><span>maxNumberOfKeysInSegmentWriteCache</span><strong class="value-config" th:text="${node.maxNumberOfKeysInSegmentWriteCache}">0</strong></div>
        <div class="line"><span>maxNumberOfKeysInSegmentWriteCacheDuringMaintenance</span><strong class="value-config" th:text="${node.maxNumberOfKeysInSegmentWriteCacheDuringMaintenance}">0</strong></div>
        <div class="line"><span>Estimated Segment Cache Key Limit (all segments)</span><strong class="value-config" th:text="${node.estimatedSegmentCacheKeyLimit}">0</strong></div>
        <div class="line"><span>Segment Cache Keys (runtime)</span><strong class="value-runtime" th:text="${node.totalSegmentCacheKeys}">0</strong></div>
        <div class="line"><span>Segment Cache Pressure</span><strong class="value-runtime"><span th:text="${node.segmentCachePressurePercent}">0</span>%</strong></div>
        <div class="line"><span>Write Cache Keys (runtime)</span><strong class="value-runtime" th:text="${node.totalWriteCacheKeys}">0</strong></div>
      </article>

      <article class="card section">
        <h3>Segment Registry Cache</h3>
        <div class="line"><span>Max Number Of Segments In Registry Cache</span><strong class="value-config" th:text="${node.cacheLimit}">0</strong></div>
        <div class="line"><span>Registry Cache Hits / Misses</span><strong class="value-runtime"><span th:text="${node.cacheHitCount}">0</span> / <span th:text="${node.cacheMissCount}">0</span></strong></div>
        <div class="line"><span>Registry Cache Load / Evict</span><strong class="value-runtime"><span th:text="${node.cacheLoadCount}">0</span> / <span th:text="${node.cacheEvictionCount}">0</span></strong></div>
        <div class="line"><span>Registry Cache Size</span><strong class="value-runtime"><span th:text="${node.cacheSize}">0</span></strong></div>
        <div class="line"><span>Registry Cache Hit Ratio</span><strong class="value-runtime"><span th:text="${node.registryCacheHitRatioPercent}">0</span>%</strong></div>
        <div class="line"><span>Registry Cache Fill</span><strong class="value-runtime"><span th:text="${node.registryCacheFillPercent}">0</span>%</strong></div>
      </article>

      <article class="card section">
        <h3>Bloom Filter</h3>
        <div class="mono" style="margin-bottom:8px;">Values are aggregated over all segments in this node.</div>
        <div class="line"><span>Bloom Requests</span><strong class="value-runtime" th:text="${node.bloomFilterRequestCount}">0</strong></div>
        <div class="line"><span>Refused by Bloom (negative)</span><strong class="value-runtime" th:text="${node.bloomFilterRefusedCount}">0</strong></div>
        <div class="line"><span>Positive Responses</span><strong class="value-runtime" th:text="${node.bloomFilterPositiveCount}">0</strong></div>
        <div class="line"><span>False Positives</span><strong class="value-runtime" th:text="${node.bloomFilterFalsePositiveCount}">0</strong></div>
        <div class="line"><span>Bloom Hash Functions</span><strong class="value-config" th:text="${node.bloomFilterHashFunctions}">0</strong></div>
        <div class="line"><span>Bloom Index Size</span><strong class="value-config" th:text="${node.bloomIndexSizeHumanReadable}">0 B</strong></div>
        <div class="line"><span>Bloom False Positive Probability</span><strong class="value-config" th:text="${node.bloomFilterProbabilityOfFalsePositive}">0</strong></div>
      </article>
    </section>

    <article class="card legend">
      <h3>How To Read Values</h3>
      <p><strong class="value-config">Configuration value</strong>: muted text with lock icon means static setup loaded from index configuration.</p>
      <p><strong class="value-runtime">Runtime value</strong>: stronger text with pulse dot means live measured counters/latencies updated during operation.</p>
    </article>
  </div>
</main>
</body>
</html>
